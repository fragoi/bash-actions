#!/bin/bash -e
set -o pipefail

VERSION_INDEX=${DEB_VERSION_INDEX:-3}

writeChangelog() {
  local version=$1
  local series_index=$(( VERSION_INDEX - 1 ))
  fetchChangelog "$version" "$series_index" \
    | shortlog \
    | streamNotEmpty \
    | debChangelogEntryAdd "$version"
}

version=$(debChangelogVersion)

if [ ! "$version" ]; then
  echo 1>&2 "cannot read version from changelog"
  exit 1
fi

tag=$(versionTagName "$version")

if isHead "$tag"; then
  echo 1>&2 "no modifications since ${version}"
  exit 0
fi

if [ "$(getRefId $tag)" ]; then
  version=$(nextVersionExt "$version" "$VERSION_INDEX")
  if ! writeChangelog "$version"; then
    echo 1>&2 "changelog is empty, not creating new version"
    exit 0
  fi
fi

setGitIdentity

createTag "$version"
